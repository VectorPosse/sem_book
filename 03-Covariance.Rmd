# Covariance {#covariance}

```{r, echo = FALSE, fig.align= "center"}
knitr::include_graphics("graphics/covariance.png")
```


## Calculating covariance {#covariance-calculating}

The last chapter was about variance, which measures the spread of a single variable. Now we extend this idea to pairs of variables.

We say that two variables "co-vary" when the spread of one variable is related to the spread of another variable. This relationship represents an *association* between the two variables.

We'll call our two variables $X_{1}$ and $X_{2}$. To keep things simple, let's assume that we have already mean centered our variables.

::: {.rmdnote}

If $X_{1}$ and $X_{2}$ are already mean centered, then what are $\overline{X_{1}}$ and $\overline{X_{2}}$?

:::

As we did in the last chapter with variance, we'll build up the calculation of covariance step-by-step using a table to keep track of intermediate quantities we need.

Here are two variables (with $n = 7$) that have been mean centered:

| $X_{1}$ | $X_{2}$ |
|--------:|--------:|
| -1      | -2      |
| -2      |  2      |
|  2      | -2      |
| -3      | -1      |
|  4      |  2      |
| -1      | -2      |
|  1      |  3      |

::: {.rmdnote}

Check that the mean of both columns is truly zero.

:::

Something interesting happens when we look at the product $X_{1}X_{2}$.

::: {.rmdnote}

If $X_{1}$ and $X_{2}$ both lie above their means, they are both positive numbers. Therefore, their product is positive.

What if both $X_{1}$ and $X_{2}$ lie below their means? What do we know about their values individually and what do we know about their product?

:::

Here is the chart again, but with the products listed in a new column:

| $X_{1}$ | $X_{2}$ | $X_{1}X_{2}$ |
|--------:|--------:|-------------:|
| -1      | -2      |  2           |
| -2      |  2      | -4           |
|  2      | -2      | -4           |
| -3      | -1      |  3           |
|  4      |  2      |  8           |
| -1      | -2      |  2           |
|  1      |  3      |  3           |

Now we add up the products across all seven data pairs:

| $X_{1}$ | $X_{2}$ | $X_{1}X_{2}$ |
|--------:|--------:|-------------:|
| -1      | -2      |  2           |
| -2      |  2      | -4           |
|  2      | -2      | -4           |
| -3      | -1      |  3           |
|  4      |  2      |  8           |
| -1      | -2      |  2           |
|  1      |  3      |  3           |
|         |         | Sum: 10      |


So when $X_{1}$ and $X_{2}$ tend to have similar values (both positive or both negative), their product is usually positive. It's not true of every pair of values in the table above; some products are negative. But the majority are positive. Therefore, the sum of all such products will be positive.

We're almost there. Just like we wanted the average squared deviation to calculate the variance, here we want the average of the products from the third column above. And just like in the case of variance, it's not *quite* the average we calculate. Instead of dividing by $n$, we divide by $n - 1$ for exactly the same esoteric reason. In our example, there are 7 data points (in other words, 7 rows of data), so we divide by 6.

Putting this all together:

| $X_{1}$ | $X_{2}$ | $X_{1}X_{2}$ |
|--------:|--------:|-------------:|
| -1      | -2      |  2           |
| -2      |  2      | -4           |
|  2      | -2      | -4           |
| -3      | -1      |  3           |
|  4      |  2      |  8           |
| -1      | -2      |  2           |
|  1      |  3      |  3           |
|         |         | Sum: 10      |
|         |         | Covariance: 10/6 = $\boxed{1.67}$ |

In our diagrams, the covariance of two variables is indicated by a curved, double-headed arrow pointing at both boxes and labeled with the value of the covariance, like this:

```{r, echo = FALSE, fig.align= "center"}
knitr::include_graphics("graphics/covariance_labeled.png")
```

Note that we still include the variances of each of the individual variables. They are still important to us. We just have one new type of arrow now.

::: {.rmdnote}

Verify that the variances in the diagram are correct for our example. You can do it by hand if you want, but using R is fine too.

:::

Here is the final formula for covariance, written as $Cov\left(X_{1}, X_{2}\right)$. This works for all pairs of variables, even if they aren't mean centered. The terms $\left(X_{1} - \overline{X_1}\right)$ and $\left(X_{2} - \overline{X_2}\right)$ do the mean centering:


::: {.rmdimportant}

$$
Cov\left(X_{1}, X_{2}\right) = \frac{\sum \left(X_{1} - \overline{X_{1}}\right)\left(X_{2} - \overline{X_{2}}\right)}{n - 1}
$$
:::

::: {.rmdnote}

Suppose $X_{1}$ tends to be above its mean when $X_{2}$ is below its mean and $X_{1}$ tends to be below its mean when $X_{2}$ is above its mean. What will the product $\left(X_{1} - \overline{X_{1}}\right)\left(X_{2} - \overline{X_{2}}\right)$ usually be? Therefore, what will the sum of all such products likely be?

:::

For general variables (not necessarily mean centered), the table will actually look like this:

|$X_{1}$| $X_{2}$|$\left(X_{1} - \overline{X_{1}}\right)$ | $\left(X_{2} - \overline{X_{2}}\right)$ | $\left(X_{1} - \overline{X_{1}}\right)\left(X_{2} - \overline{X_{2}}\right)$ |
|----:|----:|----:|----:|----:|
| 17  | 23  | -2  | 11  | -22 |
| 25  | 15  |  6  | 3   |  18 |
| ... | ... | ... | ... | ... |



::: {.rmdnote}

Calculate the covariance by hand by making a table like the one above. (These variables are *not* mean centered, so you'll have to calculate the mean of each variable in order to fill out the third and fourth columns.)

$X_{3}$: 8, 10, 16, 7, 4, 3

$X_{4}$: 6, 5, 4, 9, 11, 7

Explain intuitively why the covariance is negative for these two variables.

:::


::: {.rmdnote}

When calculating variance, the order of the data points does not matter. Why?

When calculating covariance, the order of the data points *does* matter. Why?

What if you keep pairs together, but rearrange the rows of the table. How does that affect the covariance?

:::


## Calculating covariance in R {#covariance-r}

Once weâ€™ve done it by hand a few times to make sure we understand how the formula works, from here on out we can let R do the work for us:

```{r}
X1 <- c(-1,-2, 2, -3, 4, -1, 1)
X2 <- c(-2, 2, -2, -1, 2, -2, 3)
cov(X1, X2)
```

```{r}
X3 <- c(8, 10, 16, 7, 4, 3)
X4 <- c(6, 5, 4, 9, 11, 7)
cov(X3, X4)
```

And here's some real world data:

```{r}
cov(airquality$Temp, airquality$Wind)
```

## Covariance rules {#covariance-rules}

We'll think of the variance and covariance rules as one big list. We left off on [**Rule 4**](./variance.html#Rule4), so now we'll introduce [**Rule 5**](#Rule5).

::: {.rmdimportant}

-  <a id = "Rule5">**Rule 5**</a>

$$
Cov(X, X) = Var(X)
$$

:::

In words, [**Rule 5**](#Rule5) states that the covariance of a variable *with itself* is just the same thing as the variance of that variable. This is quite remarkable! It means that variance is really just a special case of covariance.

::: {.rmdnote}

Explain why [**Rule 5**](#Rule5) is true. (Hint: think about how you would calculate $Cov(X, X)$ using either the formula or the table---or both!)

:::

::: {.rmdimportant}

-  <a id = "Rule6">**Rule 6**</a>

$$
Cov\left(X_{1}, X_{2}\right) = Cov\left(X_{2}, X_{1}\right)
$$

:::

In words, we would say that covariance is *symmetric*.

::: {.rmdnote}

Explain why [**Rule 6**](#Rule6) is true. (Again, think about the formula or the table---or both!)

:::

The next four rules are analogous to similar rules for variance ([**Rule 1**](./variance.html#Rule1), [**Rule 2**](./variance.html#Rule2), [**Rule 3**](./variance.html#Rule3), and [**Rule 4**](./variance.html#Rule4)).

::: {.rmdimportant}

-  <a id = "Rule7">**Rule 7**</a>

Suppose that $C$ is a "constant" variable, meaning that it always has the same value (rather than being a variable that could contain lots of different numbers). Then,

$$
Cov\left(X, C\right) = 0
$$
:::

::: {.rmdnote}

As always, try to explain this rule. Give an intuitive explanation of why this rule "should" be true. Then think about it computationally, thinking of either the formula or the table---or both!

:::

::: {.rmdimportant}

-  <a id = "Rule8">**Rule 8**</a>

$$
Cov\left(X_{1} + X_{2}, X_{3}\right) = Cov\left(X_{1}, X_{3}\right) + Cov\left(X_{2}, X_{3}\right)  
$$

:::

What you should appreciate here is that there is no longer any restriction on the relationships among the variables involved. [**Rule 2**](./variance.html#Rule2) only worked when the two variables were independent. On the other hand, [**Rule 8**](#Rule8) works for any combination of variables, no matter their relation.

Even more satisfying is this next rule:

::: {.rmdimportant}

-  <a id = "Rule9">**Rule 9**</a>

$$
Cov\left(X_{1} - X_{2}, X_{3}\right) = Cov\left(X_{1}, X_{3}\right) - Cov\left(X_{2}, X_{3}\right)  
$$
:::

Yay! The minus sign behaves sensibly now! Of course, since covariances can be positive or negative (unlike variances which are always positive!) we can more safely subtract two of them without worry. And this rule, like [**Rule 8**](#Rule8), does not depend on $X_{1}$ and $X_{2}$ being independent. They can be any two variables.

There are versions of these rules with the addition or subtraction on the other side, but these are just minor variations of [**Rule 8**](#Rule8) and [**Rule 9**](#Rule9), so they're not worth mentioning as a separate rule. Remember that covariance is symmetric, so you can always swap things on the left and right of the comma.

::: {.rmdimportant}

$$
Cov\left(X_{1}, X_{2} \pm X_{3}\right) = Cov\left(X_{1}, X_{2}\right) \pm Cov\left(X_{1}, X_{3}\right)  
$$
:::

::: {.rmdimportant}

-  <a id = "Rule10">**Rule 10**</a>

If $a$ is any number, 

$$
Cov\left(a X_{1}, X_{2}\right) = a Cov\left(X_{1}, X_{2}\right) =  Cov\left(X_{1}, a X_{2}\right)  
$$
:::

This rule is also very sensible. Instead of [**Rule 4**](./variance.html#Rule4) that takes a number $a$ and pulls out an $a^{2}$, [**Rule 10**](#Rule10) just pulls out a single factor of $a$ (from either slot).

Just a couple more rules. We were talking about independence in conjunction with [**Rule 8**](#Rule8) and [**Rule 9**](#Rule9). That leads directly to an interesting and super-important rule:

::: {.rmdimportant}

-  <a id = "Rule11">**Rule 11**</a>

If $X_{1}$ and $X_{2}$ are independent, then

$$
Cov\left(X_{1}, X_{2}\right) = 0
$$
:::

::: {.rmdnote}

Why is [**Rule 11**](#Rule11) true, intuitively?

It's interesting to note that this rule only works one way. In other words, if you know that two variables are independent, then you can conclude their covariance is zero. However, if you know the covariance is zero, that doesn't necessarily mean that the two variables are independent. We'll see an example of this later in the chapter.

:::

Finally, one rule to rule them all:

::: {.rmdimportant}

-  <a id = "Rule12">**Rule 12**</a>

For *any* two variables $X_{1}$ and $X_{2}$:

$$
Var(aX_{1} + bX_{2}) = 
    a^2Var(X_{1}) + b^2Var(X_{2}) + 2abCov(X_{1}, X_{2})
$$

:::

This brings practically everything we know together into one rule!

::: {.rmdnote}

Proving [**Rule 12**](#Rule12) will give us good practice with the type of manipulation we'll need to do in future chapters. So here goes. For the first few steps, you name what rule we're invoking. Then, you'll pick up the thread and follow it through the last few steps on your own.

\begin{align}
Var(aX_{1} + bX_{2}) &= Cov(aX_{1} + bX_{2}, aX_{1} + bX_{2}) \\
    &= Cov(aX_{1} + bX_{2}, aX_{1}) + Cov(aX_{1} + bX_{2}, bX_{2}) \\
    &=  Cov(aX_{1}, aX_{1}) + 
        Cov(bX_{2}, aX_{1}) + \\
    &   \qquad Cov(aX_{1}, bX_{2}) + 
        Cov(bX_{2}, bX_{2}) \\
    &= \quad ???
\end{align}

:::




## Correlation {#covariance-correlation}


## Visualizing covariance and correlation {#covariance-visualizing}